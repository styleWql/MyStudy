<!DOCTYPE html>
<html>

<head>
  <title></title>
  <link rel='stylesheet' href='/stylesheets/detail.css' />
  <link rel='stylesheet' href='/stylesheets/bootstrap.css' />
  <link rel='stylesheet' href='stylesheets/style.css' />
  <link rel='stylesheet' href='stylesheets/index.css' />
</head>
<style>
  #img {
    width: 45px;
    height: 45px;
    margin-right: 10px;
  }
  .line {
    height: 500px;
  }
  #big_box{
  width: 1000px;
  height: 500px;
  overflow: hidden;
}

</style>

<body>
  <% include template/header.ejs%>
  <!-- <div class="container-sm border border-primary">100% wide until small breakpoint</div> -->
  <div class="container border z_border"  style="padding: 0px;  border: 0px solid #dee2e6 !important;">
  <div id="main">

<!-- 

  è¿™é‡Œæ”¾çš„æ˜¯é‚£å››å¼ è¯¦æƒ…å›¾ç‰‡

 -->


  </div>
  

    <div class="comment">
      <div class="reviewbox">
       <span></span>  <span>  è¯„è®º  </span><span id="review"> 0</span>
      </div>
      <!-- å‘å¸ƒ -->
      <div class="release">
        <img class="h_img" id="h_img" src=" " alt="">
        <!-- <img class="h_img" src="/detail_img/005.jpg" alt=""> -->
        <!-- <input class="put_box" type="text"> -->
        <textarea id="t_area" class="put_box" name="" id="" cols="30" rows="10">

        </textarea>
        <!-- ä¸Šä¼ å›¾ç‰‡ -->
        <div id="line">
          <div class="cover"> ä¸Šä¼ å›¾ç‰‡ </div>
          <input id="file" type="file" name="" id="file">
          <button id="z_btn" onclick="doUpload()">æäº¤</button>
        </div>
        <!-- ä¸Šä¼ å›¾ç‰‡å®Œ -->
        <button id="btn" class="btn btn-primary p_comment">å‘è¡¨è¯„è®º</button>
      </div>
      <!-- å‘å¸ƒå®Œ -->
      <div class="com_number">

        <!-- å±•ç¤ºåŒº -->

      </div>
      <div id="pageBox"></div>

      <button class="show btn btn-primary btn-lg btn-block" id="z_color"> æ˜¾ç¤ºå…¨éƒ¨ </button>

      <div class="recommend">

        <span></span>&nbsp;&nbsp;æ¨è&nbsp;&nbsp;<span></span>
      </div>
      <div id="big_box">
      <div id="listbox" class="row d-flex mt-6 justify-content-between flex-wrap">

      </div> <!-- listbox end -->
      <% include template/footer.ejs%>
    </div>

<!-- <img src="/images/1_å¤©å›å…¬å›­.jpg" alt=""> -->

    </div>
  </div>
  </div>
  <div class="position-fixed div_bot"><img src="/com_img/è¿”å›é¡¶éƒ¨.png" alt=""></div>
  <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.js"></script>
  <script>

    // console.log("è¿™æ˜¯å‘¨ä¸šå¤çš„é¡µé¢",sessionStorage.id); 
    
    var box_node = ' '
    var imgs_src = ' '
    var nums = 500
    /* å›¾ç‰‡æ‡’åŠ è½½ */

    /* åŠ è½½è¯¦æƒ…æ¨èçš„å›¾ç‰‡ */

    function many_img(){
      // console.log("æ²¡æˆåŠŸ");
      
      $.ajax({
        url: `rend_images.jsp?`, //è¯·æ±‚çš„urlåœ°å€
        // dataType:"json", //è¿”å›æ ¼å¼ä¸ºjson
        async: true, //è¯·æ±‚æ˜¯å¦å¼‚æ­¥ï¼Œé»˜è®¤ä¸ºå¼‚æ­¥ï¼Œè¿™ä¹Ÿæ˜¯ajaxé‡è¦ç‰¹æ€§
        data: {
          "id": "value"
        }, //å‚æ•°å€¼
        type: "GET", //è¯·æ±‚æ–¹å¼
        beforeSend: function () {
          //è¯·æ±‚å‰çš„å¤„ç†
        },
        success: function (req) {
          //è¯·æ±‚æˆåŠŸæ—¶å¤„ç†
          var rend_two = req.data

          $.each(rend_two, function (i, n) {
            // console.log(n);
            imgs_src +=(`
              <div class="card mt-4 " id="z_page" data-id=${n.id} >
                <img id="list_img" src="" class="" data-id=${n.id} data-src="${n.v_img}" alt="">
                <div class="card-body z_card" data-id=${n.id}>
                    <h5 >${n.v_name}</h5>
                    <p >${n.a_info}</p>
                    <a href="#" class="btn btn-primary" data-id=${n.id}> æŸ¥çœ‹è¯¦æƒ… </a>
                </div>
            </div> 
            `)
          })
          $(listbox).append($(imgs_src))
          // console.log($(list_img));
          
/* æ‡’åŠ è½½ */

            var clock; 
            $(window).on('scroll',function(){
                if(clock){
                    clearTimeout(clock);
                }
                clock = setTimeout(function(){
                    start()
                },200)
            })
            function start(){
                 $('.container img').not('[data-isLoading]').each(function (){
                    if (isShow($(this))) {
                        loadImg($(this));
                    }
                })
            }
            function isShow($node){
                return $node.offset().top <= $(window).height()+$(window).scrollTop();
            }
            function loadImg($img){
              nums+=185
                    $img.attr('src', $img.attr('data-src'));
                    
                    $img.attr('data-isLoading',1);
                    $(big_box).css("height",nums)
            }

/* æ‡’åŠ è½½ */

          // console.log($(z_page));
          /* æ”¾åœ¨manyé‡Œé¢ */
    // console.log("è¿™æ˜¯sssid",sessionStorage.id);

$(z_page).click(function (e) {
  vid()
  box_node = ' '
  
   sessionStorage.id = e.target.dataset.id //ç‚¹å‡»æ—¶å€™è·å–æ¯å¼ å›¾ç‰‡å¯¹åº”çš„   v_id
  //  console.log("è¿™æ˜¯sessionStorage.id: ",sessionStorage.id);
  // console.log();
  four_img()

})
/* æ”¾åœ¨manyé‡Œé¢å®Œ */
          
        },
        complete: function () {
          //è¯·æ±‚å®Œæˆçš„å¤„ç†
        },
        error: function () {
          //è¯·æ±‚å‡ºé”™å¤„ç†
        }
      });

    }

    many_img()

    /* åŠ è½½è¯¦æƒ…æ¨èçš„å›¾ç‰‡ */

/* ajax å°è£… è¯·æ±‚é‚£å››å¼ å›¾ç‰‡çš„ */
    function vid(){
      $.ajax({
        url: `rend_img.jsp?arr=1&num=r&v_id=${sessionStorage.id}`,
        type: 'GET',
        success: function (data) {
          var rend_one = data.data
          // console.log(rend_one);
          $.each(rend_one, function (i, n) {
            if((i+1)%2 ==0){
              box_node += `
                <div class="box">
      <span></span>
      <div class="text" style="text-align: right;">${n.d_info}</div>
      <img id="imginfo" src="${n.img_src}" alt="">
    </div>
                `
            }else{
              box_node += `
                <div class="box">
      <span></span>
      <img id="imginfo" src="${n.img_src}" alt="">
      <div class="text" style="text-align: right;">${n.d_info}</div>
    </div>
                `
            }
            window.location.href="http://localhost:3000/detail.html";

          })
          $(main).html(`${box_node}`)



        }
      })
    }

/* ajax å°è£…å®Œ è¯·æ±‚é‚£å››å¼ å›¾ç‰‡çš„ */



/* æ¸²æŸ“è¯¦æƒ…é¡µé¢çš„å››å¼ å›¾ */

function four_img(){
  // console.log(1);
  box_node = ' '
  $.ajax({
        url: `/four_img.jsp?v_id=${sessionStorage.id}`,
        type: 'GET', // æ‰“æˆçš„æ•°æ®åŒ…å¯ä»¥ç›´æ¥é€šè¿‡sendå‘é€
        success: function (data) {
            var rend_one = data.data
          // console.log(rend_one);
          /* ç«‹å³æ¸²æŸ“å››å¼ å›¾ */

          $.each(rend_one, function (i, n) {
            if((i+1)%2 ==0){
              box_node += `
                <div class="box">
      <span></span>
      <div class="text" style="text-align: right;">${n.d_info}</div>
      <img id="imginfo" src="${n.img_src}" alt="">
    </div>
                `
            }else{
              box_node += `
                <div class="box">
      <span></span>
      <img id="imginfo" src="${n.img_src}" alt="">
      <div class="text" style="text-align: right;">${n.d_info}</div>
    </div>
                `
            }

          })
          $(main).html(`${box_node}`)
          /* ç«‹å³æ¸²æŸ“å››å¼ å›¾ */
        }
      })
}
four_img()

/* æ¸²æŸ“è¯¦æƒ…é¡µé¢çš„å››å¼ å›¾å®Œ */


    /* å›¾ç‰‡æ‡’åŠ è½½å®Œ */


    let arr = []
    let str = ''
    let reply_node_str = ' '
    let time = " "
    let num = 0
    let text = ''
    var userid = JSON.parse(sessionStorage.userInfo).t_user
    // var head_src = JSON.parse(sessionStorage.userInfo).t_headimg

    var head_src = sessionStorage.head_str

    // console.log(sessionStorage.head_str);
    
    $("#h_img").attr("src", `${head_src}`);
    // console.log(JSON.parse(sessionStorage.userInfo).t_headimg);
    
    

    let page_num = 1
    let page_count = 6
    let the_height = 1080

    //æ¸²æŸ“è¯„è®º
    // $(document).ready(function () {
    function getListFn() {
      // let listbox = document.querySelector('#listbox')

      // listbox.innerHTML = ''
      $.ajax({
        url: `getRender.jsp?arr=${arr}&time=${time}&page_num=${page_num}&page_count=${page_count}&v_id=${sessionStorage.id}`, //è¯·æ±‚çš„urlåœ°å€
        // dataType:"json", //è¿”å›æ ¼å¼ä¸ºjson
        async: true, //è¯·æ±‚æ˜¯å¦å¼‚æ­¥ï¼Œé»˜è®¤ä¸ºå¼‚æ­¥ï¼Œè¿™ä¹Ÿæ˜¯ajaxé‡è¦ç‰¹æ€§
        // data: {
        //   "id": "value"
        // }, //å‚æ•°å€¼
        // data:{
        //   'data':data
        // },
        type: "GET", //è¯·æ±‚æ–¹å¼
        beforeSend: function () {
          //è¯·æ±‚å‰çš„å¤„ç†
        },
        success: function (req) {
          // console.log(req);

          //è¯·æ±‚æˆåŠŸæ—¶å¤„ç†
          var ren = req.data
          // console.log(ren);
          if (req.code == 0) {
            let node_str = ''

          console.log('è¿™æ˜¯è¯„è®º',$(review).html(`${ren.length}`));
            

          $(".com_number").html(' ')
          $.each(ren, function (i, n) {

                node_str = `<div class='new'>  
    <img class="h_img" src="${n.t_headimg}" alt="">
    <div class="father">
    <div class="title">${n.t_user}</div>
    <div class="put_box msg">${n.c_content}</div>
    <div class="like">
    <span> ${n.c_time}</span>
    <span id="heart">ğŸ’›:<span id='like'>${n.c_likes}</span></span>
    <span id="Reply">å›å¤</span>
        
      </div>
      </div>
      </div>
      
      `
              $(".com_number").prepend(node_str)

            });
            // æ¸²æŸ“åˆ†é¡µ
            new Pagination({
              el: '#pageBox',
              counter: Math.ceil(req.list_count / page_count),
              page_num: page_num,
              callback: function (id) {
                page_num = id
                getListFn()
              }
            })
          } else {
            // console.log('err');
          }
        },
        complete: function () {
          //è¯·æ±‚å®Œæˆçš„å¤„ç†
        },
        error: function () {
          //è¯·æ±‚å‡ºé”™å¤„ç†
        }
      });
      // })
    }
    getListFn()

    function parseDom(arg) {
      var objE = document.createElement("div");
      objE.innerHTML = arg;
      return objE.children[0];
    }

    function Pagination(parmas) {
      this.el = document.querySelector(parmas.el) // æ’ä»¶ç›®æ ‡èŠ‚ç‚¹
      this.counter = parmas.counter //æ€»é¡µæ•°
      this.pages = null //æ ¹æ®æ€»é¡µæ•° ç”Ÿæˆçš„ åˆ†é¡µ æŒ‰é’®
      this.callback = parmas.callback || function () {} // åˆ†é¡µæŒ‰é’®ç‚¹å‡»çš„ å›è°ƒå‡½æ•° å¯ä»¥æ˜¯ å‘èµ· ajaxè¯·æ±‚
      // åˆ†é¡µä¸»ä½“ ä»£ç  
      this.wrap = parseDom(`
                        <nav aria-label="Page navigation example center">
                        <ul class="pagination _top">
                            <li class="page-item" ><a id="pri" class="page-link" href="#">ä¸Šä¸€é¡µ</a></li>
                            <li class="page-item" ><a id="next" class="page-link" href="#">ä¸‹ä¸€é¡µ</a></li>
                        </ul>
                    </nav>
    `);
      this.id = 0
      this.page_num = parmas.page_num
      this.init()
      this.handle()
    }
    Pagination.prototype = {
      constructor: Pagination,
      init() {
        // å¦‚æœé¡µé¢æ²¡æœ‰ ä¸»ä½“ ç»“æ„ æ‰ç”Ÿæˆ ä¸»ä½“ ç»“æ„  é¿å…æ¯æ¬¡ç‚¹å‡» ç”Ÿæˆ
        if (!document.querySelector('nav')) {
          this.el.appendChild(this.wrap)
        }
        // ç”Ÿæˆ åˆ†é¡µ æŒ‰é’®
        let str = ''
        for (let i = 1; i <= this.counter; i++) {
          str = parseDom(`<li class="page-item"><a id="pgid" class="page-link" href="#" data-id=${i} >${i}</a></li>
            `)
          // console.log(str);
          if (document.querySelector('.pagination').children.length <= this.counter + 1) {
            document.querySelector('.pagination').insertBefore(str, document.querySelector(
              '.pagination li:last-child'))
          }
        }
      },
      handle() {
        // ç»‘å®šäº‹ä»¶
        this.el.addEventListener('click', function (e) {
          e.preventDefault();
          // console.dir(e.target);

          if (e.target.id == "next") { //ä¸‹ä¸€é¡µ
            // this.id = this.page_num+1
            // console.log(this.counter);

            // if(this.id>this.counter){//ä¸Šä¸€é¡µ
            //   console.log('bigbig');

            //   this.id=this.counter
            // }
            // this.callback(this.id)
          } else if (e.target.id == "pri") {
            // this.id = this.page_num-1
            // if(this.id<0){
            //   this.id=1
            // }
            // this.callback(this.id)
          } else if (e.target.id == "pgid") {
            this.id = e.target.dataset.id
            this.callback(this.id)
          }

        }.bind(this))
      }
    }

    /* ç‚¹å‡»æ˜¾ç¤ºå…¨éƒ¨è¯„è®º */
    $(z_color).click(function () {
      this.remove()
      $(".com_number").css("height", 1080)
      $("._top").css("opacity", 1)

    })


    /* æ”¾å›¾ */
    function doUpload() {
      let file = $('#file').get(0).files[0] //è·å–ä¸Šä¼ çš„
      // console.log(file);

      let formdata = new FormData()
      formdata.append('hehe', file) 
      // console.log(file);       
      $.ajax({
        url: 'http://localhost:3000/file/upload',
        type: 'post',
        cache: false,
        data: formdata, // æ‰“æˆçš„æ•°æ®åŒ…å¯ä»¥ç›´æ¥é€šè¿‡sendå‘é€
        processData: false,
        contentType: false,
        success: function (data) {
          $(t_area).html(' ')
          if (data.err == 0) {
            console.log(data);
            $(t_area).val(`<img id="img" src="/comment_img${data.img}" alt="">`)

          } else {
            console.log('ä¸Šä¼ å¤±è´¥è¯·é‡è¯•');
          }
        }
      })
    }
    /* æ”¾å›¾ */
    /* å›å¤ */

    function sendmsg(arr, time, userid) {

      // console.log(v_id);
      

      $.ajax({
        url: `getdetail.jsp?arr=${arr}&time=${time}&userid=${userid}&v_id=${sessionStorage.id}&t_headimg=${head_src}`, //è¯·æ±‚çš„urlåœ°å€
        // dataType:"json", //è¿”å›æ ¼å¼ä¸ºjson
        async: true, //è¯·æ±‚æ˜¯å¦å¼‚æ­¥ï¼Œé»˜è®¤ä¸ºå¼‚æ­¥ï¼Œè¿™ä¹Ÿæ˜¯ajaxé‡è¦ç‰¹æ€§
        data: {
          "id": "value"
        }, //å‚æ•°å€¼
        type: "GET", //è¯·æ±‚æ–¹å¼
        beforeSend: function () {
          //è¯·æ±‚å‰çš„å¤„ç†
        },
        success: function (req) {
          //è¯·æ±‚æˆåŠŸæ—¶å¤„ç†
          console.log(req);
        },
        complete: function () {
          //è¯·æ±‚å®Œæˆçš„å¤„ç†
        },
        error: function () {
          //è¯·æ±‚å‡ºé”™å¤„ç†
        }
      });
    }


    /* å›å¤ */



    //ç‚¹å‡»è¯„è®º
    $(btn).click(function () {
      if($("#username") && sessionStorage.userInfo){
      str = $(t_area).val()
      arr.push(str)
      $(t_area).val(" ")
      time = new Date().toLocaleString()
      node_str = $(`<div class='new'>  
      <img class="h_img" src="${head_src}" alt="">
      <div class="father">
      <div class="title">${userid}</div>
      <div class="put_box msg">${str}</div>
      <div class="like">
    <span> ${time}</span>
    <span id="heart">ğŸ’› :<span id='like'>0</span></span>
    <span id="Reply">å›å¤</span>
    </div>
    </div>
    </div>`)
      sendmsg(arr, time, userid)
      /*  è¯·æ±‚è¯„è®ºå®Œ */
      $(".com_number").prepend(node_str)
  }else{
        window.location.href='login.html'
    }

    })
    //ç‚¹å‡»è¯„è®ºå®Œ


    // var arr = []
    /* å‘èµ·ç‚¹èµ  */
    var math = 1
    $(".com_number").click(function (e) {
      e.preventDefault()
 
      if (e.target.id == "heart") {
        // console.log($(e.target).children().html());
        var sstr = $(e.target).parent().prev().text()
        // let userid = parseInt($(e.target).parent().prev().prev().html())
        var htmlarr = e.target.innerHTML
        htmlarr = htmlarr.split(":")
        // console.log(htmlarr);
        // let userid = 123
        let num = parseInt($(e.target).children().html())
        // if(userid = 4 )
        e.target.innerHTML = `â¤:${htmlarr[1]}`
        if (htmlarr[0] == "ğŸ’›") {
          num++
        }

        $(e.target).children().html(`${num}`)
        // console.log(userid);
        // console.log(sstr);

        /* å‘èµ·ç‚¹èµ  */

        $.ajax({
          url: `getlikes.jsp?num=${num}&sstr=${sstr}&userid=${userid}`, //è¯·æ±‚çš„urlåœ°å€
          // dataType:"json", //è¿”å›æ ¼å¼ä¸ºjson
          async: true, //è¯·æ±‚æ˜¯å¦å¼‚æ­¥ï¼Œé»˜è®¤ä¸ºå¼‚æ­¥ï¼Œè¿™ä¹Ÿæ˜¯ajaxé‡è¦ç‰¹æ€§
          data: {
            "id": "value"
          }, //å‚æ•°å€¼
          type: "GET", //è¯·æ±‚æ–¹å¼
          beforeSend: function () {
            //è¯·æ±‚å‰çš„å¤„ç†
          },
          success: function (req) {
            //è¯·æ±‚æˆåŠŸæ—¶å¤„ç†
            // console.log(req);
            // console.log(req);
            
            // console.log(req.data_inner_two.length);
            // if(req.data_inner_two.length>1){
            //   alert`ä½ ä¸å¯ä»¥è¯„è®º`;
            // }
          },
          complete: function (req) {
            //è¯·æ±‚å®Œæˆçš„å¤„ç†
            // console.log(req);

          },
          error: function () {
            //è¯·æ±‚å‡ºé”™å¤„ç†
          }
        });
        /* å‘èµ·ç‚¹èµç»“æŸ  */
      }
      if (e.target.id == "Reply") {
        /* ç‚¹å‡»å‡ºç°å›å¤æ¡† */
        var str = parseDom(` <div id="reply_box">è¿™æ˜¯ä¸€ä¸ªæ–°çš„div</div>`)
        var newstr = parseDom(`
        <div class="release reply_release" id="release">
        <img class="h_img" src="${head_src}" alt="">
        <!-- <input class="put_box" type="text"> -->
        <textarea id="z_area" class="put_box" name="" id="" cols="30" rows="10">
          
        </textarea>
        <!-- ä¸Šä¼ å›¾ç‰‡ -->

        <!-- ä¸Šä¼ å›¾ç‰‡å®Œ -->
        <button id="an_btn" class="btn btn-primary p_comment">å‘è¡¨è¯„è®º</button>
      </div>
        `)
        /* ç‚¹å‡»å‡ºç°å›å¤æ¡†å®Œ */
        math++
        // console.log(math);
        // arr.push($(newstr))
        if (math % 2 == 0) {
          $(newstr).insertAfter($(e.target).parent().parent().parent())
          // console.log($(".z_file"));

          var username = $(e.target).parent().prev().prev().html()
          // console.dir(username);
          $(an_btn).click(function (e) {
            // var myname = " å‘¨ä¸šå¤ "
            // var reply_node = parseDom(`<div id="reply_box"></div>`)
            // $(reply_node).insertBefore($(release))
            /* å›å¤çš„å†…å®¹æ¸²æŸ“åˆ°é¡µé¢ */
            text = $(z_area).val()
            text = `${userid} @${username} ${text}`
            arr.push(text)
            // console.log(arr);
            // str = $(t_area).val()
            // arr.push(str)
            // $(t_area).val(" ")
            time = new Date().toLocaleString()
            reply_node_str = parseDom(`  <div class='new'>  
      <img class="h_img" src="${head_src}" alt="">
      <div class="father">
      <div class="title">${userid}</div>
      <div class="put_box msg"> ${text}</div>
      <div class="like">
    <span> ${time}</span>
    <span id="heart">ğŸ’› :<span id='like'>0</span></span>
    <span id="Reply">å›å¤</span>
    </div>
    </div>
    </div>
                  `)
            $(reply_node_str).insertBefore($(release))

            // console.log(reply_node_str);
            $(z_area).val(' ')

            $("reply_box").prepend($("reply_box"))
            the_height += 200
            console.log(the_height);

            $(".com_number").css("height", the_height)
            /* å›å¤çš„å†…å®¹æ¸²æŸ“åˆ°é¡µé¢ */

            sendmsg(arr, time, userid)
            /*  è¯·æ±‚è¯„è®ºå®Œ */
          })
        } else {
          $(release).remove()
        }
      }
    })
  </script>

<script src="/javascript/detailed.js"></script>
<script src="/javascript/header.js"></script>
</body>

</html>